# MkDocs + Read the Docs 多语言文档项目构建要点

本文档梳理了本项目从零到一的构建过程，总结了核心技术、项目结构、关键配置及工作流，可作为后续维护和学习的参考。

---

### 1. 核心技术：MkDocs

- **MkDocs** 是本项目的核心。它是一个基于 Python 的、快速、简洁的**静态网站生成器**，专门用于构建项目文档。
- 工作模式：用 Markdown 编写文档，通过一个 YAML 配置文件 (`mkdocs.yml`) 来定义网站，最终生成一个完整的静态 HTML 网站。

---

### 2. 项目目录结构

经过重构，我们采用了**完全独立的语言目录**结构，不再设置共享资源：

```
.
├── .readthedocs.yaml     # Read the Docs 的总配置文件
├── mkdocs_en.yml         # 英文版 MkDocs 配置
├── mkdocs_zh.yml         # 中文版 MkDocs 配置
└── docs/
    ├── en/               # 英文版文档源文件
    │   ├── index.md
    │   └── images/       # 英文版资源 (图片等)
    │       └── image1.png
    └── zh/               # 中文版文档源文件
        ├── index.md
        └── images/       # 中文版资源 (图片等)
            └── image1.png
```

- **完全隔离**：`en` 和 `zh` 目录完全独立，各自维护自己的 Markdown 文件和图片等资源。这种方式结构更清晰，避免了共享资源可能带来的耦合问题。

---

### 3. 关键配置文件解析

#### a) `mkdocs_en.yml` & `mkdocs_zh.yml` (单个语言的大脑)

这两个文件内容类似，以中文版为例，其核心配置项为：

- `docs_dir: docs/zh/`: **这是关键**。它告诉 MkDocs 在构建时，只把 `docs/zh/` 目录当作文档的根目录。这确保了在构建中文版时，不会包含任何英文版的文件，实现了语言的**构建隔离**。
- `nav`: 定义了该语言版本的导航栏结构，所有路径都是相对于 `docs_dir` 的。
- `markdown_extensions`: 我们用它开启了 `attr_list` 扩展，目的是让 Markdown 解析器能识别并处理图片后面的 `{width=180}` 这样的属性，从而控制图片的显示尺寸。

#### b) `.readthedocs.yaml` (构建流程的总指挥)

这是整个自动化和多语言构建流程的**核心**。它告诉 Read the Docs 平台具体要如何操作您的代码仓库：

- **`build.jobs.pre_build`**: 定义了在运行主要的 `mkdocs build` 命令**之前**需要执行的一系列脚本命令。
- **判断语言与选择配置**: 脚本的核心是 `if [ "$READTHEDOCS_LANGUAGE" = "zh-cn" ]`。`$READTHEDOCS_LANGUAGE` 是 Read the Docs 提供的环境变量。
  - 脚本通过判断这个变量，将对应语言的配置文件（`mkdocs_zh.yml` 或 `mkdocs_en.yml`）复制为 `mkdocs.yml`。
  - 这是因为 Read the Docs 默认会寻找并使用名为 `mkdocs.yml` 的文件来执行构建。
- **构建逻辑简化**: 请注意，原先用于复制共享 `assets` 目录的 `cp -r` 命令**已被移除**。因为现在每个语言目录都维护自己的资源，构建前不再需要任何文件操作，流程更简洁。

### 4. Read the Docs 平台配置 (多语言的粘合剂)

- **单一项目 + 翻译**：我们在 Read the Docs 上采用的是**一个主项目**（比如英文版）并为其添加**一个翻译**（中文版）的模式。
- **自动切换器**：这种模式是实现网站右下角出现**语言切换菜单**的前提。Read the Docs 会自动发现这两个版本的关联，并生成切换功能。
- **URL 结构**：这种模式也决定了您网站的 URL 结构，即通过 `/en/` 和 `/zh-cn/` 来区分不同语言。

---

### 5. 总结：完整工作流

1.  您将代码 `push` 到 GitHub。
2.  该 `push` 操作触发了 Read the Docs 上的**两次构建**：一次为 `en`，一次为 `zh-cn`。
3.  **在构建 `zh-cn` 版本时**：
    a. Read the Docs 设置环境变量 `$READTHEDOCS_LANGUAGE` 为 `zh-cn`。
    b. `.readthedocs.yaml` 中的脚本检测到这个值，于是选择 `mkdocs_zh.yml` 作为配置文件（通过重命名）。
    c. MkDocs 基于 `docs/zh` 目录和中文配置，生成一套纯净的中文版 HTML 网站。
4.  **在构建 `en` 版本时**：重复类似的过程，生成英文版网站。
5.  Read the Docs 将这两套独立的网站分别部署到 `/zh-cn/` 和 `/en/` 路径下，最终呈现给用户一个完整的多语言文档。

---

### 6. 核心架构决策：多语言方案对比

在项目初期，我们对多语言实现方案进行了评估。最终选择的“分离构建”模式是基于 Read the Docs 平台的最佳实践。理解这一点对于后续维护至关重要。

#### 方案一：Read the Docs 原生方案（分离构建） - (当前方案)

这是我们目前采用的方案。

- **工作模式**：
  1.  在 Read the Docs 上创建**一个项目**，并为其添加“翻译”（指向同一个代码仓库，但指定不同语言）。
  2.  为每种语言创建一个独立的 `mkdocs_xx.yml` 配置文件。
  3.  `.readthedocs.yaml` 在构建时，根据语言选择对应的配置文件。
  4.  Read the Docs 为每个语言独立运行一次构建。

- **优点**：
  - **完美平台集成**：能够无缝使用 Read the Docs 提供的所有原生功能，特别是与版本（latest/stable）深度绑定的语言切换器。
  - **高度健壮**：每个语言的构建过程完全隔离，一个语言的文档或配置错误不会影响其他语言。
  - **配置清晰**：每个 `mkdocs_xx.yml` 文件只关心自己的语言，职责分明。

- **缺点**：
  - 在 Read the Docs 服务器上，每个语言都需要一次构建，总构建时间会略长。

#### 方案二：mkdocs-static-i18n 插件方案（统一构建）

这是另一种常见的方案，更适用于非 Read the Docs 平台（如 GitHub Pages）。

- **工作模式**：
  1.  只使用一个 `mkdocs.yml` 文件。
  2.  通过 `mkdocs-static-i18n` 插件来管理所有语言的配置。
  3.  运行 `mkdocs build` 时，插件会**一次性构建**出所有语言的站点。
  4.  插件会**自行生成**一套语言切换器注入到页面中。

- **缺点（在 Read the Docs 场景下）**：
  - **功能冲突**：插件自制的切换器会与 Read the Docs 原生的切换器冲突，导致用户体验不佳，并丢失平台特性。
  - **增加依赖**：引入了第三方插件，增加了项目的不确定性和维护成本。
  - **构建耦合**：所有语言在同一次构建中处理，增加了整体构建失败的风险。

#### 常见误区澄清

1.  **“需要创建多个 Read the Docs 项目吗？”**
    不，只需要**一个项目**，然后在该项目的后台添加“翻译”即可。

2.  **“不同语言的文档页面必须一一对应吗？”**
    不。Read the Docs 的切换器很智能。如果您从页面 A (EN) 切换到中文，它会尝试寻找对应的页面 A (ZH)。如果找不到，它会**自动回退到中文版的首页**，而不会报错。

#### 结论

**对于托管在 Read the Docs 上的项目，方案一（我们当前的方案）是无可争议的最佳实践。** 它最大化地利用了平台优势，实现了功能、健壮性和可维护性三者之间的最佳平衡。方案二更适合那些需要自力更生、无法依赖强大平台特性的托管环境。